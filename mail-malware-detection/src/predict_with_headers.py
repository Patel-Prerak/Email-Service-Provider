"""
Prediction with text + header features.
Loads pipeline and returns phishing probability for an email.
"""
import argparse
import joblib
import pandas as pd
import json


def predict_phishing(model_path, subject='', body='', receiving_chain=None, esp='unknown', 
                     spf_pass=False, dkim_pass=False, dmarc_pass=False):
    """
    Load pipeline and predict phishing probability.
    
    Args:
        model_path: Path to saved pipeline
        subject: Email subject
        body: Email body
        receiving_chain: Receiving chain (string semicolon-separated or list)
        esp: Email Service Provider name
        spf_pass: SPF authentication passed (bool)
        dkim_pass: DKIM authentication passed (bool)
        dmarc_pass: DMARC authentication passed (bool)
    
    Returns:
        dict with is_phishing, probability, risk_level
    """
    # Ensure feature_extractor is available when unpickling
    import sys
    import os
    src_dir = os.path.dirname(os.path.abspath(__file__))
    if src_dir not in sys.path:
        sys.path.insert(0, src_dir)
    
    pipeline = joblib.load(model_path)
    
    # Prepare input as DataFrame (matching training schema)
    if isinstance(receiving_chain, list):
        receiving_chain = ';'.join(receiving_chain)
    
    input_data = pd.DataFrame({
        'text': [subject + ' ' + body],
        'receiving_chain': [receiving_chain or ''],
        'esp': [esp],
        'spf_pass': [int(spf_pass)],
        'dkim_pass': [int(dkim_pass)],
        'dmarc_pass': [int(dmarc_pass)],
        'subject': [subject],
    })
    
    prob = pipeline.predict_proba(input_data)[0, 1]
    pred = 1 if prob > 0.7 else 0  # More conservative threshold to reduce false positives

    # Map probability to risk level (adjusted for better calibration)
    if prob < 0.5:
        risk_level = 'LOW'
    elif prob < 0.75:
        risk_level = 'MEDIUM'
    elif prob < 0.9:
        risk_level = 'HIGH'
    else:
        risk_level = 'CRITICAL'

    return {
        'is_phishing': bool(pred),
        'confidence': float(prob),
        'risk_level': risk_level,
        'message': f"Phishing probability: {prob*100:.1f}%"
    }


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('--model', default='models/phishing_pipeline.joblib')
    parser.add_argument('--subject', default='')
    parser.add_argument('--body', default='')
    parser.add_argument('--receiving-chain', default='')
    parser.add_argument('--esp', default='unknown')
    parser.add_argument('--spf-pass', type=int, default=0)
    parser.add_argument('--dkim-pass', type=int, default=0)
    parser.add_argument('--dmarc-pass', type=int, default=0)
    args = parser.parse_args()

    result = predict_phishing(
        args.model,
        subject=args.subject,
        body=args.body,
        receiving_chain=args.receiving_chain,
        esp=args.esp,
        spf_pass=bool(args.spf_pass),
        dkim_pass=bool(args.dkim_pass),
        dmarc_pass=bool(args.dmarc_pass),
    )
    print(json.dumps(result, indent=2))
