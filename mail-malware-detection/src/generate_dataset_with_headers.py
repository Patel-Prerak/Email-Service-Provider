"""
Generate a synthetic multilingual phishing dataset (English + Hindi) with header features.
Outputs a CSV with columns: subject, body, receiving_chain, esp, spf_pass, dkim_pass, dmarc_pass, label
Run: python generate_dataset_with_headers.py --out ../data/raw/phishing_dataset.csv --n 5000
"""
import argparse
import random
import csv
import json

ENGLISH_PHISH = [
    "Urgent: Verify your account",
    "Your account has been suspended",
    "Update payment information immediately",
    "Confirm your login",
    "Password reset required",
    "Claim your refund now",
    "Unusual sign-in attempt detected",
    "Hurry up fill the form to get free money",
    "Act now: Limited time offer for you",
    "You have won a prize!",
    "Congratulations! Claim your bonus",
    "Click here to activate your account",
    "Your card is about to expire",
    "Bank security alert",
    "Re-confirm identity NOW",
    "Free money waiting for you",
    "Don't miss out on free cash",
    "Urgent action required on your account",
]
ENGLISH_BENIGN = [
    "Meeting agenda for tomorrow",
    "Weekly report attached",
    "Lunch plans",
    "Project update: milestones",
    "Invoice for your recent purchase",
    "Family photos from weekend",
    "Conference call reminder",
    "Team outing this Friday",
    "Budget review spreadsheet",
    "Client feedback summary",
    "Office supplies order",
    "Training session materials",
]
HINDI_PHISH = [
    "कृपया अपना खाता सत्यापित करें",
    "आपका खाता निलंबित कर दिया गया है",
    "भुगतान जानकारी तुरंत अपडेट करें",
    "पासवर्ड रीसेट करें",
    "संदिग्ध लॉगिन का प्रयास देखा गया",
    "जल्दी फॉर्म भरें और मुफ्त पैसा पाएं",
    "आपने पुरस्कार जीता है",
    "तुरंत कार्य करें आपके खाते पर",
]
HINDI_BENIGN = [
    "आइए शुक्रवार को मिलते हैं",
    "सप्ताहिक रिपोर्ट संलग्न है",
    "छुट्टी की तस्वीरें साझा कर रहा हूँ",
    "बैठक की एजेंडा",
    "परियोजना अपडेट",
]

PHISH_BODY_SNIPPETS = [
    "Click this link to verify: http://example.com/verify",
    "Please login immediately: http://bad.example/login",
    "We detected suspicious activity - confirm your identity",
    "Your payment failed. Update details here: http://pay.example/",
    "Hurry up fill the form to get free money and win big! Click: http://temp-link.xyz/form",
    "Act now to claim your free prize. Don't miss out! http://prize.example/claim",
    "Limited time: Get free cash instantly at http://freemoney.com/form",
    "You've been selected for free money! Fill form now: http://winning.example/",
    "Congratulations! You won. Verify here: http://verify-now.example/",
    "Bank alert: Confirm payment info at http://bank-secure.example/",
    "Card expiring: Update now at http://card-update.example/",
]
BENIGN_BODY_SNIPPETS = [
    "Please find the attached document for your review.",
    "Let's catch up later this week about the project.",
    "Here are the meeting notes from yesterday.",
    "The quarterly report is ready for your review.",
    "Following up on our previous discussion.",
    "Please see attached for more details.",
]

HINDI_PHISH_BODY = [
    "कृपया इस लिंक पर क्लिक कर के सत्यापित करें: http://example.com/verify",
    "हमने संदिग्ध गतिविधि देखी, कृपया पुष्टि करें",
    "जल्दी करें और मुफ्त पैसा पाने के लिए फॉर्म भरें: http://temp-link.xyz/form",
    "तुरंत आपके पैसे पाने का यह अंतिम मौका है! http://freemoney.com/click",
]

HINDI_BENIGN_BODY = [
    "यहाँ पिछली बैठक के नोट्स हैं।",
    "आपसे कल मिलने की आशा है।",
    "त्रैमासिक रिपोर्ट समीक्षा के लिए तैयार है।",
]

ESP_LIST = ['gmail', 'outlook', 'yahoo', 'protonmail', 'unknown', 'spoofed']
CHAIN_SAMPLES = [
    ['mail.gmail.com', 'smtp.google.com'],
    ['smtp.office365.com', 'outlook.com'],
    ['unknown.mailserver.net'],
    ['compromised.server.com', 'relay.net', 'user.mail'],
]


def make_sample(phish_probability=0.5):
    is_phish = random.random() < phish_probability
    lang = 'en' if random.random() < 0.8 else 'hi'
    
    if is_phish:
        if lang == 'en':
            subject = random.choice(ENGLISH_PHISH)
            body = random.choice(PHISH_BODY_SNIPPETS)
        else:
            subject = random.choice(HINDI_PHISH)
            body = random.choice(HINDI_PHISH_BODY)
    else:
        if lang == 'en':
            subject = random.choice(ENGLISH_BENIGN)
            body = random.choice(BENIGN_BODY_SNIPPETS)
        else:
            subject = random.choice(HINDI_BENIGN)
            body = random.choice(HINDI_BENIGN_BODY)
    
    if random.random() < 0.3:
        body += "\n\n" + random.choice(["Regards, Team", "Thanks", "-- Admin"])
    
    # Header features: STRONGLY COUPLED with phishing label for better realism
    if is_phish:
        # Phishing emails often fail authentication or come from suspicious sources
        spf_pass = random.random() < 0.3      # Only 30% pass SPF
        dkim_pass = random.random() < 0.2     # Only 20% pass DKIM
        dmarc_pass = random.random() < 0.1    # Only 10% pass DMARC
        
        esp = random.choice(['unknown', 'spoofed', 'gmail', 'outlook', 'yahoo'])
        receiving_chain = random.choice(CHAIN_SAMPLES[2:]) 
    else:
        # Benign emails usually pass authentication, BUT sometimes they don't (e.g. misconfigured servers, manual tests)
        # We introduce 20% "noisy benign" samples to force model to look at text too
        is_noisy = random.random() < 0.2
        
        if is_noisy:
            spf_pass = random.random() < 0.5
            dkim_pass = random.random() < 0.5
            dmarc_pass = random.random() < 0.5
            esp = random.choice(['unknown', 'gmail', 'outlook'])
            receiving_chain = random.choice(CHAIN_SAMPLES) # Random chain
        else:
            spf_pass = random.random() < 0.95     # 95% pass SPF
            dkim_pass = random.random() < 0.90    # 90% pass DKIM
            dmarc_pass = random.random() < 0.85   # 85% pass DMARC
            esp = random.choice(['gmail', 'outlook', 'yahoo', 'protonmail'])
            receiving_chain = random.choice(CHAIN_SAMPLES[:2])
    
    return subject, body, ';'.join(receiving_chain), esp, int(spf_pass), int(dkim_pass), int(dmarc_pass), int(is_phish)


def generate(out_path, n=5000):
    with open(out_path, 'w', newline='', encoding='utf-8') as f:
        writer = csv.writer(f)
        writer.writerow(['subject', 'body', 'receiving_chain', 'esp', 'spf_pass', 'dkim_pass', 'dmarc_pass', 'label'])
        for _ in range(n):
            writer.writerow(make_sample())


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('--out', default='data/raw/phishing_dataset.csv')
    parser.add_argument('--n', type=int, default=5000)
    args = parser.parse_args()
    generate(args.out, args.n)
    print(f"Generated {args.n} samples to {args.out}")
