"""
Feature extraction for phishing detection.
Combines text features (TF-IDF) with header-derived features.
"""
import pandas as pd
from sklearn.base import BaseEstimator, TransformerMixin
from sklearn.preprocessing import StandardScaler
import numpy as np


class HeaderFeatureExtractor(BaseEstimator, TransformerMixin):
    """
    Extract numerical features from email headers.
    Input: DataFrame with columns: receiving_chain, esp, spf_pass, dkim_pass, dmarc_pass, subject_length
    Output: 2D array of numeric features
    """
    
    def __init__(self):
        self.scaler = StandardScaler()
        self.is_fitted = False
    
    def fit(self, X, y=None):
        # Dummy fit for the pipeline
        return self
    
    def transform(self, X):
        """
        X: DataFrame with header info
        Returns: 2D array of shape (n_samples, n_features)
        """
        features = []
        
        for idx, row in X.iterrows():
            feat_row = []
            
            # 1. Receiving chain length (more hops = potentially suspicious)
            receiving_chain = row.get('receiving_chain', [])
            if isinstance(receiving_chain, str):
                chain_len = len(str(receiving_chain).split(';')) if receiving_chain else 0
            else:
                chain_len = len(receiving_chain) if isinstance(receiving_chain, list) else 0
            feat_row.append(float(chain_len))
            
            # 2. ESP (Email Service Provider) - one-hot later, here just encode as numeric
            #    Common phishing ESPs get higher scores (proxy: 1 if known_phish_esp, 0 otherwise)
            esp = str(row.get('esp', 'unknown')).lower()
            esp_risk = 1.0 if esp in ['unknown', 'spoofed'] else 0.0
            feat_row.append(esp_risk)
            
            # 3. SPF pass (bool: 1 if yes, 0 if no) - phishing often fails SPF
            spf_pass = float(row.get('spf_pass', 0))
            feat_row.append(spf_pass)
            
            # 4. DKIM pass (bool)
            dkim_pass = float(row.get('dkim_pass', 0))
            feat_row.append(dkim_pass)
            
            # 5. DMARC pass (bool)
            dmarc_pass = float(row.get('dmarc_pass', 0))
            feat_row.append(dmarc_pass)
            
            # 6. Subject length (phishing often has urgent/short subjects)
            subject_len = float(len(str(row.get('subject', ''))))
            feat_row.append(subject_len)
            
            features.append(feat_row)
        
        return np.array(features, dtype=np.float32)


def create_header_data(receiving_chain=None, esp='unknown', spf_pass=False, 
                       dkim_pass=False, dmarc_pass=False, subject=''):
    """
    Helper to create header feature row for a single email.
    """
    return {
        'receiving_chain': receiving_chain or [],
        'esp': esp,
        'spf_pass': int(spf_pass),
        'dkim_pass': int(dkim_pass),
        'dmarc_pass': int(dmarc_pass),
        'subject': subject,
    }
