# Mail Phishing Detection (Extended with Header Features)

This module provides a focused phishing-email detector with multilingual support (English-focused, with Hindi samples) that combines **text features (TF-IDF)** with **header-derived features** (SPF/DKIM/DMARC, receiving chain, ESP). It replaces the prior malware folder and is designed for production deployment.

## Quick Start

**Note:** We use a Python virtual environment at `./.venv` in the repo root (already configured).

### 1. Activate the virtual environment
```powershell
& C:/Users/patel/Desktop/old/email-analyzer/.venv/Scripts/Activate.ps1
```

### 2. Install dependencies
```powershell
python -m pip install -r mail-malware-detection/requirements.txt
```

### 3. Generate dataset (5000 samples: 80% English, 20% Hindi)
```powershell
python mail-malware-detection/src/generate_dataset_with_headers.py --out mail-malware-detection/data/raw/phishing_dataset.csv --n 5000
```

### 4. Train model (80/20 split, text + header features)
```powershell
python mail-malware-detection/src/train_with_headers.py --data mail-malware-detection/data/raw/phishing_dataset.csv --model-out mail-malware-detection/models/phishing_pipeline.joblib
```

Output will show:
- Classification report (Precision, Recall, F1-score)
- Confusion matrix
- ROC-AUC score

### 5. Test prediction (CLI)
```powershell
python mail-malware-detection/src/predict_with_headers.py --model mail-malware-detection/models/phishing_pipeline.joblib --subject "Verify your account" --body "Click this link" --esp gmail --spf-pass 1 --dkim-pass 1 --dmarc-pass 1
```

Output example:
```json
{
  "is_phishing": false,
  "confidence": 0.15,
  "risk_level": "LOW",
  "message": "Phishing probability: 15.0%"
}
```

## Architecture

### Feature Pipeline
- **Text features:** TF-IDF (word n-grams 1-2, char n-grams 3-5) via `FeatureUnion`
- **Header features:** 
  - Receiving chain length
  - ESP risk score (unknown/spoofed = risky)
  - SPF/DKIM/DMARC pass flags (phishing often fails)
  - Subject length
- **Classifier:** Logistic Regression with class balancing

### Training Process
1. Load CSV (subject, body, receiving_chain, esp, spf_pass, dkim_pass, dmarc_pass, label)
2. Combine subject+body into single text field
3. Apply `ColumnTransformer` to process text and headers separately
4. Stratified 80/20 train-test split
5. Train pipeline with `LogisticRegression`
6. Evaluate on test set (Precision, Recall, F1, ROC-AUC)
7. Save entire pipeline to `models/phishing_pipeline.joblib`

### Risk Levels
- **LOW:** confidence < 0.3 (benign)
- **MEDIUM:** 0.3 ≤ confidence < 0.6 (suspicious)
- **HIGH:** 0.6 ≤ confidence < 0.8 (likely phishing)
- **CRITICAL:** confidence ≥ 0.8 (high-confidence phishing)

## Backend Integration

The NestJS backend (`malware-detection.service.ts`) now:
1. Loads the saved pipeline at startup
2. On each email fetched by IMAP:
   - Extracts text (subject+body)
   - Extracts header features (receiving chain, ESP, SPF/DKIM/DMARC from authentication-results header)
   - Calls Python predict script with both feature sets
   - Returns `{ is_phishing, confidence, risk_level, message }`
3. Stores result in MongoDB alongside header analysis

### Expected Backend Call
```typescript
const phishingResult = await malwareDetectionService.detectMalware({
  subject: 'Verify your account',
  body: 'Click here to verify...',
  receivingChain: ['mail.gmail.com', 'smtp.google.com'],
  esp: 'gmail',
  spfPass: true,
  dkimPass: true,
  dmarcPass: true,
});
// Returns: { is_phishing: false, confidence: 0.12, risk_level: 'LOW', message: '...' }
```

## Files

- `src/generate_dataset_with_headers.py` — Generates 5000 synthetic multilingual samples
- `src/feature_extractor.py` — `HeaderFeatureExtractor` class for header feature engineering
- `src/train_with_headers.py` — Training script with `ColumnTransformer` + `Pipeline`
- `src/predict_with_headers.py` — CLI and function for prediction with header features
- `src/utils.py` — Helper utilities
- `requirements.txt` — Dependencies (pandas, scikit-learn, joblib, numpy)
- `models/phishing_pipeline.joblib` — Trained pipeline (created after `train_with_headers.py`)

## Future Enhancements

- Add URL/link analysis (URL reputation, domain age)
- Add attachment scanning (MIME types, archives, executables)
- Integrate real labeled phishing datasets (e.g., Phishtank, SpamAssassin)
- Add model monitoring and drift detection
- Implement active learning for continuous improvement
- Support more languages (add more Hindi, Spanish, etc., samples)
